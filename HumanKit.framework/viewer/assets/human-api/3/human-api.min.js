/*
 * BioDigital Human RPC Messaging Client
 *
 * V3.0.0
 *
 * Built on 2020-02-26
 *
 * Copyright 2020, BioDigital, Inc.
 */


"use strict";var HumanAPI_MessageTypeEnum,HumanAPI_MessageStatusEnum,HumanAPI_CallbackEnum,HumanAPI=function(){function e(e){var t,n;this.eventState=((t={})[HumanAPI_CallbackEnum.HumanLoaded]=!1,t[HumanAPI_CallbackEnum.HumanReady]=!1,t),this.queuedCallbacks=((n={})[HumanAPI_CallbackEnum.HumanLoaded]=[],n[HumanAPI_CallbackEnum.HumanReady]=[],n);var s=this,a="";"string"==typeof e?a=e:"object"==typeof e&&(a=e.iframeId);var o={iframeId:a,onLoad:function(){s.eventState[HumanAPI_CallbackEnum.HumanLoaded]=!0,s._dequeueCallbacks(HumanAPI_CallbackEnum.HumanLoaded)},onReady:function(){s.eventState[HumanAPI_CallbackEnum.HumanReady]=!0,s._dequeueCallbacks(HumanAPI_CallbackEnum.HumanReady)},pollInterval:"object"==typeof e&&"number"==typeof e.pollInterval?e.pollInterval:100};this.windowRPCClient=new HumanAPI_WindowRPCClient(o)}return e.prototype.send=function(e,t,n){"function"==typeof t&&(n=t,t={}),"function"==typeof n&&(n=n.bind(this));var s=void 0!==t?t:{};return this.windowRPCClient.call(e,s,n),this},e.prototype.on=function(e,t){return this._subscribeEvent(e,t,!1)},e.prototype.once=function(e,t){return this._subscribeEvent(e,t,!0)},e.prototype._subscribeEvent=function(e,t,n){if("function"==typeof t&&(t=t.bind(this)),e===HumanAPI_CallbackEnum.HumanLoaded||e===HumanAPI_CallbackEnum.HumanReady){this.eventState[e]?t():this._queueCallback(e,t)}else{var s=n?"apiEvents.once":"apiEvents.on";this.windowRPCClient.call(s,e,t,n)}return this},e.prototype._queueCallback=function(e,t){this.queuedCallbacks[e].push(t)},e.prototype._dequeueCallbacks=function(e){this.queuedCallbacks[e].forEach(function(e){return e()}),this.queuedCallbacks[e].length=0},e}();window.HumanAPI=HumanAPI,function(e){e.Connected="connected",e.Status="status"}(HumanAPI_MessageTypeEnum=HumanAPI_MessageTypeEnum||{}),function(e){e.Connected="connected",e.Loaded="loaded",e.Ready="ready"}(HumanAPI_MessageStatusEnum=HumanAPI_MessageStatusEnum||{}),function(e){e.HumanLoaded="human.loaded",e.HumanReady="human.ready"}(HumanAPI_CallbackEnum=HumanAPI_CallbackEnum||{});var HumanAPI_Map=function(){function e(e,t){this.items=e,this.lastUniqueId=t+1}return e.prototype.addItem=function(e){for(;;){var t=this.lastUniqueId++;if(void 0===this.items[t])return this.items[t]=e,t}},e.prototype.removeItem=function(e){delete this.items[e]},e}(),HumanAPI_WindowRPCClient=function(){function e(e){this.destroyed=!1,this.connected=!1,this.pollInterval=100,this.handleMap=new HumanAPI_Map({},Date.now()),this.subs={},this.loaded=!1,this.ready=!1,this.messageBuffer=[],this.messageBufferConnected=[];var t=e.iframeId,n=e.onUnsupported,s=e.onConnected,a=e.onLoad,o=e.onReady,i=e.pollInterval;if(!t)throw new Error("config expected: iframeId");if(this.iframe=document.getElementById(t),!this.iframe)throw new Error("iframe not found: '"+t+"'");if(!this.iframe.contentWindow)throw new Error("element is not an iframe: '"+t+"'");this.destroyed=!1,this.handleMap=new HumanAPI_Map({},Date.now()),this.subs={},this.loaded=!1,this.ready=!1,this.messageBuffer=[],this.messageBufferConnected=[],this.pollInterval=i,this._connect(n,s,a,o)}return e.prototype.call=function(e,t,n,s){var a={call:e,params:t,ok:n,once:s},o=t.connected?this.messageBufferConnected:this.messageBuffer;this.connected||this.loaded||this.ready?this._send(a,n,s):o.unshift(a)},e.prototype._connect=function(i,u,r,d){var l=this,e=this._startPoll.bind(this),c=this._stopPoll.bind(this);window.addEventListener("message",function(e){var t=e.data;switch(t){case"unsupported":"function"==typeof i&&i(t);break;default:var n=void 0;try{n=JSON.parse(t)}catch(e){return}if(n.message)switch(n.message){case HumanAPI_MessageTypeEnum.Connected:l.connected=!0,c(),l._sendQueuedConnectMessages(),l._sendQueuedMessages(),"function"==typeof u&&u();break;case HumanAPI_MessageTypeEnum.Status:switch(n.status){case HumanAPI_MessageStatusEnum.Loaded:l.loaded=!0,c(),l._sendQueuedMessages(),"function"==typeof r&&r();break;case HumanAPI_MessageStatusEnum.Ready:l.ready=!0,c(),l._sendQueuedMessages(),"function"==typeof d&&d()}}if(n.results||n.response){var s=n.results||n.response;for(var a in s)if(s.hasOwnProperty(a)){var o=s[a];l.subs[a]&&l.set(a,o)}}n.error}},!1),l.iframe.addEventListener("load",e),l.iframe.addEventListener("unload",c),e()},e.prototype._startPoll=function(){this._stopPoll(),this._poll(),this.pollIntervalId=setInterval(this._poll.bind(this),this.pollInterval)},e.prototype._poll=function(){this.connected||this.destroyed||!this.iframe||!this.iframe.contentWindow?this._stopPoll():this.postMessage({action:"connect"})},e.prototype._stopPoll=function(){clearInterval(this.pollIntervalId)},e.prototype._sendQueuedMessages=function(){for(;0<this.messageBuffer.length;){var e=this.messageBuffer.pop();this._send(e,e.ok,e.once)}},e.prototype._sendQueuedConnectMessages=function(){for(;0<this.messageBufferConnected.length;){var e=this.messageBufferConnected.pop();this._send(e,e.ok,e.once)}},e.prototype._send=function(e,t,n){if(t){var s=this,a=this._on(function(e){void 0!==n&&!0!==n||s._off(a),t.call(s,e)});e.id=a,this._sendMessage(e)}else this._sendMessage(e)},e.prototype._sendMessage=function(e){this.destroyed||this.postMessage(e)},e.prototype.set=function(e,t){var n=this.subs[e];n&&n.call(this,t)},e.prototype.postMessage=function(e){this.iframe.contentWindow.postMessage(JSON.stringify(e),"*")},e.prototype._on=function(e){var t=this.handleMap.addItem();return this.subs[t]=e,t},e.prototype._off=function(e){delete this.subs[e],this.handleMap.removeItem(e)},e.prototype._destroy=function(){this.destroyed=!0},e}();